- name: Update the cache of Ubuntu packages
  ansible.builtin.apt:
    update_cache: yes
  tags:
    - apt-update-cache

- name: Install Ubuntu packages
  block:
    - name: Install packages required to add a PPA
      ansible.builtin.apt:
        install_recommends: no
        name:
          - gnupg
        state: present
        update_cache: no

    - name: Add the "deadsnakes" PPA
      ansible.builtin.apt_repository:
        repo: ppa:deadsnakes/ppa
        state: present

    # Why Python 3.7? Cf https://github.com/openfisca/openfisca-core#environment
    - name: Install Python 3.7 from "deadsnakes" PPA
      ansible.builtin.apt:
        install_recommends: no
        name:
          - acl # Provides "setfacl" command, used by Ansible to become another Unix user
          - gcc
          - nginx
          - python3.7
          - python3.7-dev
          - python3-virtualenv
        state: present
        update_cache: no

- name: Create a Unix group for the OpenFisca Web API
  ansible.builtin.group:
    name: "{{ openfisca_api_fr_unix_group_name }}"
    state: present

- name: Create a Unix user for the OpenFisca Web API
  ansible.builtin.user:
    name: "{{ openfisca_api_fr_unix_user_name }}"
    group: "{{ openfisca_api_fr_unix_group_name }}"
    shell: /bin/bash
  register: openfisca_api_fr_unix_user

- name: Define a directory to store the virtualenv of OpenFisca Web API
  ansible.builtin.set_fact:
    openfisca_api_fr_venv_dir: "{{ openfisca_api_fr_unix_user.home }}/venv"

- name: Install the latest version of OpenFisca Web API in the virtualenv with OpenFisca-France
  ansible.builtin.pip:
    # Using chdir to solve an error as explained by [this comment](https://github.com/ansible/ansible/issues/22967#issuecomment-500604054)
    chdir: "{{ openfisca_api_fr_venv_dir }}"
    name:
      - OpenFisca-Core[web-api]
      - OpenFisca-France
    state: latest
    virtualenv: "{{ openfisca_api_fr_venv_dir }}"
    virtualenv_python: python3.7
    virtualenv_site_packages: no
  become_user: "{{ openfisca_api_fr_unix_user_name }}"
  notify: Reload nginx

- name: Setup the systemd service
  block:
    - name: Create the directory receiving the environment file
      ansible.builtin.file:
        path: "{{ openfisca_api_fr_env_file | dirname }}"
        state: directory
        mode: "0755"

    - name: Copy the environment file referenced by the systemd service
      ansible.builtin.template:
        src: systemd/openfisca-web-api-fr.env.j2
        dest: "{{ openfisca_api_fr_env_file }}"

    - name: Copy the systemd service file
      ansible.builtin.template:
        src: systemd/openfisca-web-api-fr.service.j2
        dest: "{{ openfisca_api_fr_systemd_service_file }}"

    - name: Enable and start the systemd service
      ansible.builtin.systemd:
        daemon_reload: yes
        enabled: yes
        state: restarted
        name: openfisca-web-api-fr

- name: Check that OpenFisca Web API is actually started
  ansible.builtin.uri:
    return_content: yes
    status_code: 300
    timeout: 120
    url: "http://localhost:{{ openfisca_api_fr_http_port }}"
  register: this
  until: this.status == 300
  retries: 5 # times
  delay: 5 # Every 5 seconds

- name: Copy the nginx vhost file to the sites-available directory of Nginx
  ansible.builtin.template:
    src: nginx/openfisca-web-api.conf.j2
    dest: "/etc/nginx/sites-available/{{ openfisca_api_fr_host_name }}.conf"

- name: Link the nginx vhost file to the sites-enabled directory of Nginx
  ansible.builtin.file:
    src: "/etc/nginx/sites-available/{{ openfisca_api_fr_host_name }}.conf"
    dest: "/etc/nginx/sites-enabled/{{ openfisca_api_fr_host_name }}.conf"
    state: link
  notify: Reload nginx

- name: Setup SSL
  when: openfisca_api_fr_enable_ssl and openfisca_api_fr_letsencrypt_email
  block:
    - name: Install Certbot and its Nginx plugin
      ansible.builtin.apt:
        install_recommends: no
        name:
          - certbot
          - python3-certbot-nginx
        state: present
        update_cache: no

    - name: Handle staging environment
      when: openfisca_api_fr_letsencrypt_environment == "staging"
      block:
        - name: Display message when staging environment is used
          ansible.builtin.debug:
            msg: Let's Encrypt staging environment will be used

        - name: Define certbot --staging option
          ansible.builtin.set_fact:
            certbot_staging_option: "--staging"

    - name: Reinstall or renew an SSL certificate from Let's Encrypt using the certbot client
      ansible.builtin.command: >
        certbot
        --non-interactive --email {{ openfisca_api_fr_letsencrypt_email }} --agree-tos
        --nginx --redirect
        --domains {{ openfisca_api_fr_host_name }} --keep-until-expiring
        {{ certbot_staging_option | default() }}
      become_user: root
      register: certbot_result

    - name: Enable HTTP/2
      ansible.builtin.lineinfile:
        backrefs: yes
        line: '\1\2 http2;\3'
        path: "/etc/nginx/sites-available/{{ openfisca_api_fr_host_name }}.conf"
        regexp: "^(.*)(listen 443 ssl);(.+)$"
      notify: Reload nginx
      tags:
        - http2

- name: Setup auto-update
  tags:
    - auto-update
  when: openfisca_api_fr_auto_update_enable
  block:
    - name: Add the "ansible" PPA
      ansible.builtin.apt_repository:
        repo: ppa:ansible/ansible
        state: present

    - name: Install Ubuntu packages required for auto-update
      ansible.builtin.apt:
        install_recommends: no
        name:
          - ansible
          - git
        state: present
        update_cache: no

    - name: Create the Unix group for auto-update
      ansible.builtin.group:
        name: "{{ openfisca_api_fr_auto_update_unix_group_name }}"
        state: present

    - name: Create the Unix user for auto-update
      ansible.builtin.user:
        name: "{{ openfisca_api_fr_auto_update_unix_user_name }}"
        group: "{{ openfisca_api_fr_auto_update_unix_group_name }}"
        shell: /bin/bash
      register: openfisca_api_fr_auto_update_unix_user

    - name: Clone or update the "openfisca-ops" Git repository
      ansible.builtin.git:
        repo: "{{ openfisca_api_fr_auto_update_openfisca_ops_repo_url }}"
        dest: "{{ openfisca_api_fr_auto_update_unix_user.home }}/openfisca-ops"
        version: "{{ openfisca_api_fr_auto_update_openfisca_ops_branch_name }}"
      become_user: "{{ openfisca_api_fr_auto_update_unix_user_name }}"

    - name: Copy the cron job definition
      ansible.builtin.template:
        src: cron.d/openfisca-api-fr.j2
        dest: /etc/cron.d/openfisca-api-fr
